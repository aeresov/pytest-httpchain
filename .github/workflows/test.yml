name: Test

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install 3.13

            - name: Install dependencies
              run: uv sync

            - name: Check formatting
              run: uv run ruff format --check .

            - name: Check linting
              run: uv run ruff check .

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install 3.13

            - name: Install dependencies
              run: uv sync --all-extras

            - name: Run tests with coverage
              run: uv run pytest tests/unit tests/integration packages/*/tests -v --cov --cov-report=xml --cov-report=term-missing

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: false
                  verbose: true
